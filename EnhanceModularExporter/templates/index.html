<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Enhance! Modular Exporter</title><link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"></head>
<body><h1>Enhance! Modular Exporter</h1>{% with messages = get_flashed_messages(with_categories=true) %}{% if messages %}<div id="flash-messages">{% for cat, msg in messages %}<div class="flash {{ cat }}">{{ msg }}</div>{% endfor %}</div>{% endif %}{% endwith %}
    <div class="card"><h2>1. Load Conversations</h2><form method="post" enctype="multipart/form-data" action="{{ url_for('index') }}"><label for="file">Select conversations.json:</label><input type="file" id="file" name="file" accept=".json" required><button type="submit">Load File</button></form>{% if not has_data %}<p><i>Upload file to see export options.</i></p>{% endif %}</div>
    <!-- Progress Display Area -->
    <div id="progress-container" class="card" style="display: none;"><h2>Export Progress</h2><progress id="progress-bar" value="0" max="100" style="width: 100%; margin-bottom: 10px;"></progress><div id="progress-log-area" style="max-height: 250px; overflow-y: auto; background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin-top: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9em; line-height: 1.5;"></div><div id="download-link-container" style="margin-top: 15px; text-align: center;"></div></div>

    {# --- This block only renders if chat data has been loaded --- #}
    {% if has_data %}
        {# *** CORRECTED ACTION HERE: Changed url_for('export') to url_for('start_export') *** #}
        <form id="export-form" action="{{ url_for('start_export') }}" method="post"> {# JS intercepts this, but the URL needs to be buildable #}
            <div class="main-layout">
            <div class="column column-left"><div class="card filter-card"><h2>2. Filter & Select Chats</h2><div class="filter-controls"><div class="filter-group"><label for="search">Title:</label><input type="text" id="search" name="search" value="{{ filter_values.search }}" placeholder="Filter..."></div><div class="filter-group date-filter"><input type="checkbox" id="date_filter" name="date_filter" {% if filter_values.date_filter %}checked{% endif %}><label for="date_filter">Date:</label><input type="date" id="start_date" name="start_date" value="{{ filter_values.start_date }}"><span>to</span><input type="date" id="end_date" name="end_date" value="{{ filter_values.end_date }}"></div><button type="button" id="apply-filter-btn">Apply Filters</button></div><div class="chat-list-section"><label for="chat-listbox">Chats ({{ chats|length }}):</label><div class="listbox-container"><select id="chat-listbox" name="selected_chats" multiple size="15">{% for chat in chats %}<option value="{{ chat.original_index }}" title="{{ chat.title | e }}">{{ chat.title | e }}</option>{% else %}<option disabled>No matching chats.</option>{% endfor %}</select></div><div class="select-all-controls"><input type="checkbox" id="select-all-cb"><label for="select-all-cb">Select All/None</label><span id="selection-count">Selected: 0</span></div></div></div></div>
            <div class="column column-center"><div class="card options-card" id="export-options"><h2>3. Export Options</h2><fieldset><legend>Formats</legend><label><input type="checkbox" name="export_txt" value="1" checked> .txt</label><label><input type="checkbox" name="export_md" value="1" checked> .md</label><label><input type="checkbox" name="export_html" value="1"> .html</label><label><input type="checkbox" name="export_db" value="1"> .csv</label><label><input type="checkbox" name="export_sqlite" value="1"> .sqlite</label></fieldset><fieldset><legend>Folder Structure <small>(N/A if merging)</small></legend><label><input type="radio" name="folder_mode" value="Default" checked> Default</label><label><input type="radio" name="folder_mode" value="Smart"> Smart Folders</label></fieldset><fieldset><legend>File Splitting <small>(N/A if merging)</small></legend><label><input type="radio" name="split_mode" value="None" checked> None</label><label><input type="radio" name="split_mode" value="Size"> Size(MB)</label><label><input type="radio" name="split_mode" value="Count"> Count</label><input type="number" name="split_value" min="1" value="10" style="width:60px;"></fieldset><fieldset><legend>Advanced</legend><label><input type="checkbox" name="anonymize" value="1"> Anonymize</label><label><input type="checkbox" name="leet_speak" value="1"> L33t Sp34k</label><label><input type="checkbox" name="use_chatid_filename" value="1"> Filename=ID</label><label><input type="checkbox" name="html_embed_css" value="1" checked> Embed CSS</label></fieldset></div><div class="card action-buttons"><button type="submit" name="export_selected" class="export-btn">Export Selected</button><button type="submit" name="merge_selected" class="merge-btn" title="Merges selected chats.">Merge Selected</button></div></div>
            <div class="column column-right"><div class="card preview-card"><h2>Chat Preview</h2><textarea id="preview-area" readonly rows="20" placeholder="(Select a single chat to preview)"></textarea></div></div>
        </div></form>
    {% endif %}{# End if has_data #}
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body></html>